apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  creationTimestamp: '2022-04-20T13:26:58Z'
  generation: 2
  managedFields:
    - apiVersion: tekton.dev/v1beta1
      fieldsType: FieldsV1
      fieldsV1:
        'f:spec':
          .: {}
          'f:params': {}
          'f:tasks': {}
          'f:workspaces': {}
      manager: Mozilla
      operation: Update
      time: '2022-04-20T13:26:58Z'
  name: demo
  namespace: uday-test14
  resourceVersion: '100586915'
  uid: 42351666-162b-4adf-a1d6-782a75de488c
spec:
  params:
    - description: Git repository url
      name: gitUrl
      type: string
    - default: main
      description: Git revision to check out
      name: gitRevision
      type: string
    - default: src
      description: 'The path to the build context, used by Kaniko - within the workspace'
      name: pathToContext
      type: string
    - description: 'Docker file Location/Path'
      name: dockerFile
      type: string
    - description: The path to the yaml file to deploy within the git source
      name: pathToYamlFile
      type: string
    - description: Image name including repository
      name: imageUrl
      type: string
    - description: Built Image tag
      name: imageTag
      type: string
  tasks:
    - name: clone-git-repo
      params:
        - name: url
          value: $(params.gitUrl)
        - name: revision
          value: $(params.gitRevision)
        - name: subdirectory
          value: .
        - name: deleteExisting
          value: 'true'
      taskRef:
        kind: Task
        name: git-clone
      workspaces:
        - name: output
          workspace: git-source
    - name: build-and-push-image
      params:
        - name: CONTEXT
          value: $(params.pathToContext)
        - name: DOCKERFILE
          value: $(params.dockerFile)
        - name: IMAGE
          value: '$(params.imageUrl):$(params.imageTag)'
      runAfter:
        - clone-git-repo
      taskRef:
        kind: Task
        name: buildah
      workspaces:
        - name: source
          workspace: git-source
    - name: pull-image-deploy-to-cluster
      params:
        - name: pathToYamlFile
          value: ./redis-deployment.yaml
        - name: imageUrl
          value: k8s.gcr.io/redis
        - name: imageTag
          value: e2e
        - name: imageDigest
          value: $(tasks.build-and-push-image.results.IMAGE-DIGEST)
      runAfter:
        - build-and-push-image
      taskRef:
        kind: Task
        name: deploy-using-kubectl
      workspaces:
        - name: git-source
          workspace: git-source
    - name: create-service-and-expose
      params:
        - name: pathToYamlFile
          value: $(params.pathToYamlFile)
        - name: imageUrl
          value: $(params.imageUrl)
        - name: imageTag
          value: $(params.imageTag)
        - name: imageDigest
          value: $(tasks.build-and-push-image.results.IMAGE-DIGEST)
      runAfter:
        - pull-image-deploy-to-cluster
      taskRef:
        kind: Task
        name: deploy-using-kubectl
      workspaces:
        - name: git-source
          workspace: git-source
  workspaces:
    - description: The git repo
      name: git-source
